---
title: "p8105_hw6_jl5297"
author: "JunLu"
date: "11/17/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(httr)

knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%",
  warning = F,
  message = F
)
theme_set(theme_bw() + theme(legend.position = "bottom"))
```

## Problem 1

### a. Read and clean the data 
```{r}
url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"
homicide = GET(url) %>% content("raw") %>% read_csv
homicide_tidy = 
    homicide %>% 
    mutate(
        city_state = str_c(city, ", ", state),
        status = ifelse(disposition %in% c("Closed without arrest", "Open/No arrest"), 0, 1),
        status = as.factor(status)
           ) %>% 
    filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>% 
    mutate(
        victim_race = ifelse(victim_race == "White", "white", "non-white"),
        victim_race = factor(victim_race, levels = c("white", "non-white")),
        victim_age = as.numeric(victim_age)
        )
str(homicide_tidy)
```

We load the raw data from [GitHub repository](https://github.com/washingtonpost/data-homicides). The data included the location of the killing, whether an arrest was made and, in most cases, basic demographic information about each victim.

And we clean the data by following steps:

* Create a `city_state` variable by combining the `city` and `state`.
* Create a binary variable indicating whether the homicide is solved. 
* Omit cities Dallas, TX; Phoenix, AZ; Kansas City, MO and Tulsa, AL.
* Modifiy victim_race to have categories white and non-white, with white as the reference category.
* Transform `victim_age` into intergers and NA was introduced by coercion for unknown age.

Final dataset contains `r nrow(homicide_tidy)` observations and `r ncol(homicide_tidy)` variables.

* `uid`: (chr) unique identifier for each homicide record
* `reported_date`: (int) reported date 
* `victim_last`: (chr) victim last name
* `victim_first`: (chr) victim first name
* `victim_race`: (Factor) victim race
* `victim_age`: (num) victim age
* `victim_sex`: (chr) victim sex
* `city`: (chr) occurrence city
* `state`: (chr) occurrence state
* `lat`: (num) occurrence latitude
* `lon`: (num) occurrence longitude
* `disposition`: (chr) dispostion result(whether an arrest was made)
* `city_state`: (chr) city and state
* `status`: (Factor) a binary variable indicating whether the homicide is solved

### b. Fit a logistic regression for the city of Baltimore, MD
```{r}
bmore_logistic = 
    homicide_tidy %>% 
    filter(city_state == "Baltimore, MD") %>% 
    glm(status ~ victim_age + victim_sex + victim_race, family = binomial(), data = .)

bmore_or = 
    bmore_logistic %>% 
    broom::tidy() %>% 
    mutate(OR = exp(estimate)) %>%
    select(term, OR)

bmore_ci = 
    bmore_logistic %>% 
    broom::confint_tidy() %>% 
    mutate(
        conf.low = exp(conf.low),
        conf.high = exp(conf.high)
    )

cbind(bmore_or, bmore_ci) %>% knitr::kable(digits = 3)
```

I use the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Then I use `broom::tidy` and `broom::confint_tidy` to get the odds ratio and the CI.

Keeping all other variables fixedï¼Œthe odds ratio for solving homicides comparing non-white victims to white victims is 0.441 and the CI is (0.312, 0.620).

## c. Fit logistic regressions for all city
```{r}
get_or_ci = function(city_data){
    glm = glm(status ~ victim_age + victim_sex + victim_race, family = binomial(), data = city_data)
    
    or = 
    glm %>% 
    broom::tidy() %>% 
    mutate(odds_ratio = exp(estimate)) %>%
    select(term, odds_ratio)
    
    or_ci = 
    glm %>% 
    broom::confint_tidy() %>% 
    mutate(
        conf.low = exp(conf.low),
        conf.high = exp(conf.high)
    )
    
    output = cbind(or, or_ci) %>% filter(term == "victim_racenon-white") %>% select(-term)
    output
}
```
I build a function called `get_or_ci` to get the odds ratio and the CI by using `glm`, `broom::tidy` and `broom::confint_tidy`.

```{r}
glm_results =
    homicide_tidy %>% 
    group_by(city_state) %>% 
    nest() %>% 
    mutate(or_ci = map(data, ~get_or_ci(.x))) %>% 
    select(-data) %>% 
    unnest() %>% 
    mutate(
        odds_ratio = round(odds_ratio, 3),
        conf.low = round(conf.low, 3),
        conf.high = round(conf.high, 3)
    )
```

Then I use `purrr::map`, list columns, `unnest` and my own function to get adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims for each city.

```{r}
glm_results %>% 
    mutate(city_state = fct_reorder(city_state, odds_ratio)) %>% 
    ggplot(aes(x = city_state, y = odds_ratio)) + 
    geom_point() + 
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

I create a plot that shows the estimated ORs and CIs for each city. Most of cities have odds ratio below 1, which indicates there is a bias against non-white victims. Noticeably, the adjusted odds ratio of Boston is the lowest. 





